# CAN Swarm Plan - Implementation Profile Addendum (v1 → v2)

_This addendum narrows the v1 implementation to a pragmatic, centralized‑but‑replayable stack that preserves the protocol's robustness guarantees. It also documents the clean migration path to a decentralized, peer‑to‑peer profile for v2. The core protocol (envelopes, verbs, epochs/fencing, CRDT discipline for planning, scoped consensus at DECIDE, verifier quorum + challenge window, signed/replayable traces) remains unchanged._

## 1) Implementation Profiles

**Profile A - v1 (Ship Now; Simple Ops, Strong Replayability)** - **Message bus:** NATS JetStream (ordered, durable streams; consumer groups for verifier pools) - **CAS (artifacts):** MinIO/S3 (object store; application‑level content addressing by hash) - **Plan state CRDT:** Automerge (op‑log with LWW/G‑Set types per spec) - **Scoped consensus (DECIDE):** etcd‑raft library; Raft groups sharded by NEED‑hash buckets (e.g., 256) - **Policy engine:** OPA (Rego) compiled to WASM; **policy_engine_hash** embedded in envelopes; gas‑metered execution - **Crypto/identity:** libsodium (Ed25519; sealed boxes for agent‑to‑agent) - **Observability:** OpenTelemetry tracing + **signed JSONL** per thread as the canonical audit log

**Profile B - v2 (Decentralize Later; Edge‑capable)** - **Transport/pubsub:** libp2p pubsub - **CAS:** IPFS/IPLD - **Plan state:** Automerge or OrbitDB (CRDT) - **Scoped consensus:** ephemeral per‑NEED Raft groups (or a small pool keyed by slot/NEED hash) - **Identity:** DID:key / DID:peer; attested runtimes for Pro verifiers - **Sync/GC:** periodic Merkle checkpoints for fast sync and compaction

**Diagram (Profile A - v1)**

┌──────────────────────────────────────────────┐  
│ Agents & Routers │  
│ (verbs, leases, backoff, diversity weights)│  
└───────────────▲──────────────────▲───────────┘  
│ │  
Policy Capsule Plan CRDT View  
(OPA→WASM + gas) (Automerge)  
│ │  
▼ ▼  
┌───────────────────────────────────┐  
│ NATS JetStream (ordered bus) │  
│ + Signed JSONL audit threads │  
└───────────────▲───────────▲──────┘  
│ │  
etcd‑raft MinIO/S3  
(DECIDE only) (CAS)

## 2) No Double‑Stacking Rule (v1)

_To minimize complexity and operational risk, choose exactly one option per subsystem in v1._ - **Transport:** NATS JetStream **or** libp2p pubsub → **v1 uses NATS JetStream** - **CAS:** MinIO/S3 **or** IPFS/IPLD → **v1 uses MinIO/S3** - **CRDT store:** Automerge; keep exclusivity out of CRDT (handled by DECIDE) - **Consensus:** Raft for DECIDE only; no global BFT in the plan layer for v1

## 3) What Lives Where (clarifications)

**Plan CRDT (eventual consistency):** - Stores proposals/claims/attestations as an op‑log; uses LWW/G‑Set types - Does **not** implement exclusivity or global ordering guarantees

**Scoped Consensus (strong consistency at decision points):** - Exactly one **DECIDE** per **NEED**; epochs/fencing tokens prevent replays - DECIDE commits **K_plan** and emits a durable record on the bus

**Policy Capsule (deterministic):** - Rego policies compiled to WASM; execution gas‑metered - **policy_engine_hash** carried in envelopes; reject on mismatch

## 4) Scoped Consensus Adapter (implementation detail)

- **Group topology (v1):** Raft groups sharded by NEED‑hash buckets (e.g., 256 buckets)
- **Evolution (v2):** ephemeral per‑NEED Raft groups for hot slots; or a small elastic pool keyed by slot hash
- **Required properties:**
  - At‑most‑one DECIDE per NEED (enforced by epochs/fencing)
  - DECIDE includes K_plan and the current epoch/term
  - Replayable via bus + audit log

## 5) Observability & Replay (make it auditable by default)

- **Tracing:** propagate envelope/thread IDs via OpenTelemetry
- **Audit log:** every thread writes **signed JSONL** events (inputs, evaluations, DECIDE/FINALIZE)
- **Deterministic simulator:** replays JSONL; re‑executes policy WASM by **policy_engine_hash**; verifies FINALIZE byte‑for‑byte

## 6) Correctness Properties & Chaos Tests

- **P1 - Single‑DECIDE:** never two DECIDE for the same NEED
- **P2 - Deterministic replay:** identical FINALIZE under identical inputs
- **P3 - Challenge safety:** invalid FINALIZE is slashable; valid FINALIZE withstands adversarial noise during challenge window
- **P4 - Lease/fencing:** expired epoch/lease cannot DECIDE
- **Chaos set:** partitions, clock skew, message duplication, slow/failed verifiers

## 7) Economic Layer (v1 scope)

- **Credit ledger:** off‑chain; stake, unbonding, slashing, bonds
- **Payouts:** centralized for v1; payment channels optional in v2
- **Router weighting:** stake, reputation, and heterogeneity for diversity

## 8) Identity & Crypto

- **Keys:** Ed25519 via libsodium; sealed boxes for agent‑to‑agent encryption
- **Optional (v2):** DID:key / DID:peer for portable identities and VC‑backed manifests

## 9) Migration Triggers (decision table)

- **Add IPFS/libp2p** when: user‑hosted nodes or global artifact caching is required; heavy NAT traversal pain emerges
- **Raft buckets → per‑NEED groups** when: high contention with many concurrent hot NEEDs
- **Introduce DID + attestation** when: cross‑org verifiers regularly participate

## 10) Non‑Goals (v1)

- No global BFT consensus for the plan layer
- No service mesh (Istio/Linkerd) or GraphQL federation
- No blockchain settlement in the core loop

## 11) Performance SLOs (testable targets)

- **Bus:** p99 append < 25 ms; retention ≥ 7 days
- **DECIDE latency:** p95 < 2 s under target verifier pool size N
- **Policy eval:** p95 < 20 ms with gas cap G (per capsule)
- **Replay:** audit of a 10k‑event thread in < 60 s end‑to‑end

## 12) Immediate Milestones (two‑week PoC)

- **Envelope/Signature SDK**: sign/verify; lamport/nonce; capability checks
- **Policy Capsule Runner**: OPA→WASM compile; hash verification; gas metering; deterministic outputs
- **CRDT Plan Op‑log**: Automerge model + merge handlers; write/read path via bus
- **Scoped Consensus Adapter**: Raft bucket groups; DECIDE path; fencing tokens
- **Bus + Audit**: NATS streams for threads; signed JSONL writer; retention + replay tool
- **Chaos Hooks**: fault injection toggles (duplication, delay, partition); minimal Jepsen‑style nemeses
- **Property Tests**: P1-P4 checks wired into CI; replay equivalence test harness

**Outcome of the PoC:** a fully replayable job that progresses from NEED → DECIDE → FINALIZE with a verifiable, signed audit trail; simulator reproduces FINALIZE byte‑for‑byte.